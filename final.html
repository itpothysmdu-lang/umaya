<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Ageing Dashboard</title>

    <!-- Professional font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* New professional indigo + cyan theme */
            --color-bg: #F8FAFC;              /* background */
            --color-surface: #FFFFFF;        /* cards */
            --color-border: #E2E8F0;
            --color-text: #0F172A;
            --color-text-soft: #64748B;

            --color-primary: #1E3A8A;        /* deep indigo */
            --color-primary-soft: #EEF2FF;
            --color-primary-hover: #1D4ED8;
            --color-accent: #06B6D4;         /* cyan */
            --color-accent-soft: #E0F7FA;

            --color-danger: #EF4444;

            --radius-md: 10px;
            --radius-lg: 14px;
            --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.12);

            --font-sm: 12px;
            --font-base: 14px;
            --font-lg: 16px;
            --font-xl: 20px;
            --font-2xl: 24px;

            --space-4: 4px;
            --space-8: 8px;
            --space-12: 12px;
            --space-16: 16px;
            --space-20: 20px;
            --space-24: 24px;
            --space-32: 32px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: radial-gradient(circle at top left,#EFF6FF,#F8FAFC 40%,#F1F5F9);
            color: var(--color-text);
            padding: var(--space-24);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            font-size: var(--font-2xl);
            font-weight: 700;
            letter-spacing: 0.01em;
            margin-bottom: var(--space-20);
            color: var(--color-text);
            display: flex;
            align-items: center;
            gap: var(--space-8);
        }

        h1 span.icon {
            font-size: 26px;
        }

        /* Upload section */
        .upload-section {
            background: linear-gradient(135deg,#EEF2FF,#F9FAFB);
            border-radius: var(--radius-lg);
            padding: var(--space-24) var(--space-32);
            border: 1px solid rgba(129, 140, 248, 0.4);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-20);
            margin-bottom: var(--space-24);
            box-shadow: var(--shadow-soft);
        }

        .upload-left {
            display: flex;
            align-items: center;
            gap: var(--space-16);
        }

        .upload-icon {
            width: 44px;
            height: 44px;
            border-radius: 999px;
            background: radial-gradient(circle at 30% 0%,#38BDF8,#6366F1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 22px;
        }

        .upload-text-title {
            font-size: var(--font-lg);
            font-weight: 600;
        }

        .upload-text-sub {
            font-size: var(--font-sm);
            color: var(--color-text-soft);
        }

        .upload-button {
            position: relative;
            overflow: hidden;
        }

        .upload-button button {
            padding: var(--space-12) var(--space-24);
            border-radius: 999px;
            border: none;
            background: linear-gradient(135deg,#1E3A8A,#2563EB);
            color: white;
            font-size: var(--font-base);
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--space-8);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.35);
            transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
        }

        .upload-button button:hover {
            transform: translateY(-1px);
            box-shadow: 0 14px 30px rgba(30, 64, 175, 0.45);
            background: linear-gradient(135deg,#1D4ED8,#22C1C3);
        }

        .upload-button input[type="file"] {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }

        /* Grouping + ageing filters */
        .flex-row {
            display: flex;
            gap: var(--space-16);
            flex-wrap: wrap;
            margin-bottom: var(--space-16);
        }

        .card {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            padding: var(--space-20);
            border: 1px solid var(--color-border);
            box-shadow: var(--shadow-soft);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-16);
        }

        .card-title {
            font-size: var(--font-lg);
            font-weight: 600;
            letter-spacing: 0.02em;
            color: var(--color-text);
        }

        .card-sub {
            font-size: var(--font-sm);
            color: var(--color-text-soft);
        }

        .chip-row {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-8);
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: var(--space-6);
            padding: 6px 14px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.5);
            background: #F8FAFC;
            cursor: pointer;
            font-size: var(--font-sm);
            color: var(--color-text-soft);
            transition: background 0.15s ease, border-color 0.15s ease, color 0.15s ease;
        }

        .chip input {
            width: 14px;
            height: 14px;
            accent-color: var(--color-primary);
            cursor: pointer;
        }

        .chip span.label {
            user-select: none;
        }

        .chip.active {
            background: #EEF2FF;
            border-color: #4F46E5;
            color: #1E3A8A;
            font-weight: 500;
        }

        .value-select select {
            padding: 6px 12px;
            border-radius: 999px;
            border: 1px solid var(--color-border);
            font-size: var(--font-sm);
            background: #F9FAFB;
            color: var(--color-text);
        }

        /* Tiles */
        .summary-tiles {
            display: grid;
            grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
            gap: var(--space-16);
            margin: var(--space-16) 0 var(--space-24);
        }

        .tile {
            position: relative;
            border-radius: var(--radius-lg);
            padding: var(--space-16) var(--space-20);
            overflow: hidden;
            color: #0F172A;
        }

        .tile.bg-qty {
            background: radial-gradient(circle at 0 0,#E0F2FE,#EFF6FF);
        }

        .tile.bg-cost {
            background: radial-gradient(circle at 0 0,#DCFCE7,#ECFDF5);
        }

        .tile.bg-net {
            background: radial-gradient(circle at 0 0,#FAE8FF,#EEF2FF);
        }

        .tile-label {
            font-size: var(--font-sm);
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--color-text-soft);
            margin-bottom: var(--space-4);
        }

        .tile-value {
            font-size: var(--font-xl);
            font-weight: 600;
            letter-spacing: 0.04em;
            font-variant-numeric: tabular-nums;
        }

        .tile-foot {
            margin-top: 6px;
            font-size: 11px;
            color: var(--color-text-soft);
        }

        /* Tables */
        .table-section {
            margin-bottom: var(--space-24);
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-12);
        }

        .ts-title {
            font-size: var(--font-lg);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--space-8);
        }

        .ts-title span.icon {
            font-size: 20px;
        }

        .ts-sub {
            font-size: var(--font-sm);
            color: var(--color-text-soft);
            margin-top: 2px;
        }

        .copy-btn {
            padding: 8px 16px;
            border-radius: 999px;
            border: none;
            background: linear-gradient(135deg,#4F46E5,#0EA5E9);
            color: white;
            font-size: var(--font-sm);
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 6px 18px rgba(79,70,229,0.35);
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .copy-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 24px rgba(37, 99, 235, 0.5);
        }

        .copy-btn .icon {
            font-size: 16px;
        }

        .report-meta {
            font-size: var(--font-sm);
            color: var(--color-text-soft);
            margin-bottom: var(--space-8);
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: var(--radius-md);
            border: 1px solid var(--color-border);
            background: var(--color-surface);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--font-sm);
            font-variant-numeric: tabular-nums;
        }

        thead {
            background: #EEF2FF;
        }

        th, td {
            padding: 10px 14px;
            border-bottom: 1px solid #E5E7EB;
            text-align: left;
            white-space: nowrap;
        }

        th {
            font-size: 11px;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            font-weight: 600;
            color: #4B5563;
        }

        tbody tr:nth-child(even) {
            background: #F9FAFB;
        }

        tbody tr:hover {
            background: #EEF2FF;
        }

        .text-right {
            text-align: right;
        }

        .text-danger {
            color: var(--color-danger);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 999px;
            background: rgba(239,68,68,0.1);
            color: #B91C1C;
            font-size: 11px;
            font-weight: 500;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 900px) {
            body {
                padding: var(--space-16);
            }

            .upload-section {
                flex-direction: column;
                align-items: flex-start;
            }

            .table-wrapper {
                border-radius: var(--radius-md);
            }
        }
    </style>
</head>
<body>
<div class="container">
    <h1><span class="icon">ðŸ“Š</span>Stock Ageing Dashboard</h1>

    <!-- Upload -->
    <div class="upload-section">
        <div class="upload-left">
            <div class="upload-icon">â¬†</div>
            <div>
                <div class="upload-text-title">Upload stock ageing CSV</div>
                <div class="upload-text-sub">Upload your CSV file to analyze stock ageing patterns</div>
            </div>
        </div>
        <div class="upload-button">
            <button type="button">
                <span>Choose CSV file</span>
            </button>
            <input id="csvUpload" type="file" accept=".csv">
        </div>
    </div>

    <!-- Grouping & Ageing filters -->
    <div id="configRow" class="flex-row" style="display:none;">
        <div class="card" style="flex:1 1 320px;">
            <div class="card-header">
                <div>
                    <div class="card-title">Grouping</div>
                    <div class="card-sub">View ageing by Company, Purchaser, Product, or Type</div>
                </div>
            </div>
            <div id="groupingRadios" class="chip-row"></div>
            <div id="specificGrouping" style="margin-top: 12px; display: none;">
                <div class="card-sub" style="margin-bottom: 8px;">Specific Grouping:</div>
                <div class="chip-row">
                    <label class="chip">
                        <input type="checkbox" id="chk-specific-company" value="specific-company">
                        <span class="label">Specific Company</span>
                    </label>
                    <label class="chip">
                        <input type="checkbox" id="chk-specific-purchaser" value="specific-purchaser">
                        <span class="label">Specific Purchaser</span>
                    </label>
                </div>
            </div>
        </div>

        <div class="card" style="flex:1 1 340px;">
            <div class="card-header">
                <div>
                    <div class="card-title">Ageing Filters</div>
                    <div class="card-sub">Filter report based on stock age from EntryDate</div>
                </div>
                <div class="value-select">
                    <select id="valueType">
                        <option value="cost">Value by: Cost</option>
                        <option value="netlanding">Value by: Net Landing</option>
                    </select>
                </div>
            </div>
            <div class="chip-row">
                <label class="chip active">
                    <input type="checkbox" id="chk-overall" value="overall" checked>
                    <span class="label">Overall</span>
                </label>
                <label class="chip">
                    <input type="checkbox" id="chk-last30" value="last30">
                    <span class="label">Last 30 Days</span>
                </label>
                <label class="chip">
                    <input type="checkbox" id="chk-last60" value="last60">
                    <span class="label">31-60 Days (31â€“60)</span>
                </label>
                <label class="chip">
                    <input type="checkbox" id="chk-last90" value="last90">
                    <span class="label">61-90 Days (61â€“90)</span>
                </label>
                <label class="chip">
                    <input type="checkbox" id="chk-last120" value="last120">
                    <span class="label">91-120 Days (91â€“120)</span>
                </label>
                <label class="chip">
                    <input type="checkbox" id="chk-last180" value="last180">
                    <span class="label">121-180 Days (121â€“180)</span>
                </label>
                <label class="chip">
                    <input type="checkbox" id="chk-last360" value="last360">
                    <span class="label">181-360 Days (181â€“360)</span>
                </label>
                <label class="chip">
                    <input type="checkbox" id="chk-oldstock" value="oldstock">
                    <span class="label">Old Stock (360+)</span>
                </label>
            </div>
        </div>
    </div>

    <!-- Tiles -->
    <div id="summaryTiles" class="summary-tiles" style="display:none;"></div>

    <!-- Ageing Summary -->
    <div id="summaryTableSection" class="table-section card" style="display:none;">
        <div class="table-header">
            <div>
                <div class="ts-title"><span class="icon">ðŸ“ˆ</span>Ageing Summary</div>
                <div class="ts-sub">High-level ageing by bucket for current filter</div>
            </div>
            <button id="copySummaryBtn" class="copy-btn">
                <span class="icon">ðŸ“‹</span><span>Copy as Image</span>
            </button>
        </div>
        <div id="summaryMeta" class="report-meta"></div>
        <div id="summaryWrapper" class="table-wrapper">
            <table id="summaryTable"></table>
        </div>
    </div>

    <!-- Detailed -->
    <div id="detailedTableSection" class="table-section card" style="display:none;">
        <div class="table-header">
            <div>
                <div class="ts-title"><span class="icon">ðŸ“Š</span>Stock Ageing Analysis</div>
                <div class="ts-sub">Grouped ageing split by selected buckets</div>
            </div>
            <button id="copyTableBtn" class="copy-btn">
                <span class="icon">ðŸ“‹</span><span>Copy as Image</span>
            </button>
        </div>
        <div id="detailMeta" class="report-meta"></div>
        <div id="detailWrapper" class="table-wrapper">
            <table id="ageingTable"></table>
        </div>
    </div>
</div>

<!-- libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
let parsedData = [];
let columnMap = {};
let availableGroupings = [];
let currentGrouping = null;
let hasMCMData = false;
let selectedBuckets = ['overall'];
let selectedValueType = 'cost';
let specificCompany = null;
let specificPurchaser = null;

document.addEventListener('DOMContentLoaded', () => {
    const upload = document.getElementById('csvUpload');
    upload.addEventListener('change', handleFileUpload);

    document.getElementById('valueType').addEventListener('change', e => {
        selectedValueType = e.target.value;
        updateDisplay();
    });

    // Ageing bucket checkboxes
    ['chk-overall','chk-last30','chk-last60','chk-last90','chk-last120','chk-last180','chk-last360','chk-oldstock'].forEach(id => {
        const cb = document.getElementById(id);
        const chip = cb.closest('.chip');
        cb.addEventListener('change', () => {
            if (cb.checked) chip.classList.add('active'); else chip.classList.remove('active');
            updateBucketsFromUI();
        });
    });

    // Specific grouping checkboxes
    document.getElementById('chk-specific-company').addEventListener('change', e => {
        if (e.target.checked) {
            document.getElementById('chk-specific-purchaser').checked = false;
            document.getElementById('chk-specific-purchaser').closest('.chip').classList.remove('active');
            specificCompany = prompt("Enter specific company name:");
            specificPurchaser = null;
        } else {
            specificCompany = null;
        }
        updateDisplay();
    });

    document.getElementById('chk-specific-purchaser').addEventListener('change', e => {
        if (e.target.checked) {
            document.getElementById('chk-specific-company').checked = false;
            document.getElementById('chk-specific-company').closest('.chip').classList.remove('active');
            specificPurchaser = prompt("Enter specific purchaser name:");
            specificCompany = null;
        } else {
            specificPurchaser = null;
        }
        updateDisplay();
    });

    document.getElementById('copyTableBtn').addEventListener('click', () => copySectionImage('detailedTableSection'));
    document.getElementById('copySummaryBtn').addEventListener('click', () => copySectionImage('summaryTableSection'));
});

function handleFileUpload(e){
    const file = e.target.files[0];
    if (!file) return;
    Papa.parse(file,{
        header:true,
        skipEmptyLines:true,
        complete: res => processData(res.data),
        error: err => alert('CSV error: '+err.message)
    });
}

function processData(data){
    if(!data || !data.length){ alert('No rows in CSV'); return; }

    const headers = Object.keys(data[0]);
    columnMap = {};
    headers.forEach(h => {
        const trimmed = h.trim();
        columnMap[trimmed.toLowerCase()] = trimmed;
    });

    parsedData = data.map(row=>{
        const cleaned = {};
        Object.keys(row).forEach(k=> cleaned[k.trim()] = row[k]);
        const entryDate = cleaned[columnMap['entrydate']];
        cleaned._ageInDays = calcAgeDays(entryDate);
        cleaned._ageBucket = bucketFromDays(cleaned._ageInDays);
        return cleaned;
    });

    hasMCMData = parsedData.some(r=>{
        const u = r[columnMap['product unit']];
        return u && u.toUpperCase().trim()==='MCM';
    });

    const poss = [
        {key:'company name', label:'Company Name'},
        {key:'purchaser name', label:'Purchaser Name'},
        {key:'product name', label:'Product Name'},
        {key:'type name', label:'Type Name'},
        {key:'brand name', label:'Brand Name'},
        {key:'style name', label:'Style Name'}
    ];
    availableGroupings = poss.filter(g=>columnMap[g.key]);
    if(!availableGroupings.length){
        alert('No grouping columns (Company/Purchaser/Product/Type) found');
        return;
    }
    
    // Check if we have multiple companies or purchasers
    const companies = [...new Set(parsedData.map(r => r[columnMap['company name']]).filter(Boolean))];
    const purchasers = [...new Set(parsedData.map(r => r[columnMap['purchaser name']]).filter(Boolean))];
    
    // Show specific grouping options if multiple companies or purchasers exist
    if (companies.length > 1 || purchasers.length > 1) {
        document.getElementById('specificGrouping').style.display = 'block';
    }
    
    currentGrouping = availableGroupings[0].key;
    renderGroupingChips();
    document.getElementById('configRow').style.display='flex';
    updateDisplay();
}

function calcAgeDays(entry){
    if(!entry || entry==='0000-00-00') entry='2024-10-10';
    const d = new Date(entry);
    if(isNaN(d)) return 0;
    const today = new Date();
    return Math.floor(Math.abs(today-d)/(1000*60*60*24));
}

function bucketFromDays(d){
    if(d<=30) return 'last30';
    if(d<=60) return 'last60';
    if(d<=90) return 'last90';
    if(d<=120) return 'last120';
    if(d<=180) return 'last180';
    if(d<=360) return 'last360';
    return 'oldstock';
}

function renderGroupingChips(){
    const el = document.getElementById('groupingRadios');
    el.innerHTML='';
    availableGroupings.forEach(g=>{
        const label = document.createElement('label');
        label.className='chip'+(g.key===currentGrouping?' active':'');
        const input = document.createElement('input');
        input.type='radio'; input.name='grouping'; input.value=g.key;
        input.checked = g.key===currentGrouping;
        input.addEventListener('change',e=>{
            currentGrouping = e.target.value;
            document.querySelectorAll('#groupingRadios .chip').forEach(c=>c.classList.remove('active'));
            label.classList.add('active');
            updateDisplay();
        });
        const span = document.createElement('span');
        span.className='label'; span.textContent=g.label;
        label.appendChild(input); label.appendChild(span);
        el.appendChild(label);
    });
}

function updateBucketsFromUI(){
    const ids=['chk-overall','chk-last30','chk-last60','chk-last90','chk-last120','chk-last180','chk-last360','chk-oldstock'];
    selectedBuckets = ids.map(id=>document.getElementById(id))
                         .filter(cb=>cb.checked)
                         .map(cb=>cb.value);
    if(!selectedBuckets.length){
        selectedBuckets=['overall'];
        const cb = document.getElementById('chk-overall');
        cb.checked=true; cb.closest('.chip').classList.add('active');
    }
    updateDisplay();
}

function filterByBuckets(data){
    if(selectedBuckets.includes('overall')) return data;
    return data.filter(r=>selectedBuckets.includes(r._ageBucket));
}

function filterBySpecificGrouping(data) {
    if (specificCompany) {
        return data.filter(r => {
            const company = r[columnMap['company name']];
            return company && company.toLowerCase().includes(specificCompany.toLowerCase());
        });
    }
    if (specificPurchaser) {
        return data.filter(r => {
            const purchaser = r[columnMap['purchaser name']];
            return purchaser && purchaser.toLowerCase().includes(specificPurchaser.toLowerCase());
        });
    }
    return data;
}

function updateDisplay(){
    if(!parsedData.length) return;

    document.getElementById('summaryTiles').style.display='grid';
    document.getElementById('summaryTableSection').style.display='block';
    document.getElementById('detailedTableSection').style.display='block';

    updateTiles();
    updateSummaryTable();
    updateDetailTable();

    const now = new Date();
    const ts = now.toLocaleString('en-IN',{timeZone:'Asia/Kolkata',hour12:true,day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'});
    document.getElementById('summaryMeta').textContent = 'Report Generated: '+ts;
    document.getElementById('detailMeta').textContent = 'Report Generated: '+ts;
}

function updateTiles(){
    let data = filterByBuckets(parsedData);
    data = filterBySpecificGrouping(data);
    
    const colQty = columnMap['stockqty'];
    const unitCol = columnMap['product unit'];
    const costCol = columnMap['cost'];
    const netCol = columnMap['net landing'];

    const totalPCS = data.filter(r=>r[unitCol]?.toUpperCase().trim()==='PCS')
                         .reduce((s,r)=>s+Number(r[colQty]||0),0);
    const totalMCM = data.filter(r=>r[unitCol]?.toUpperCase().trim()==='MCM')
                         .reduce((s,r)=>s+Number(r[colQty]||0),0);
    const totalCost = data.reduce((s,r)=>s+Number(r[costCol]||0),0);
    const totalNet  = data.reduce((s,r)=>s+Number(r[netCol]||0),0);

    const el = document.getElementById('summaryTiles');
    el.innerHTML = `
      <div class="tile bg-qty">
        <div class="tile-label">Total Qty (PCS)</div>
        <div class="tile-value">${totalPCS.toLocaleString()}</div>
        <div class="tile-foot">Within selected ageing filters</div>
      </div>
      ${hasMCMData ? `
      <div class="tile bg-qty">
        <div class="tile-label">Total Qty (MCM)</div>
        <div class="tile-value">${totalMCM.toLocaleString()}</div>
        <div class="tile-foot">Within selected ageing filters</div>
      </div>` : ''}
      <div class="tile bg-cost">
        <div class="tile-label">Total Value (Cost)</div>
        <div class="tile-value">â‚¹${totalCost.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</div>
        <div class="tile-foot">Sum of Cost for filtered rows</div>
      </div>
      <div class="tile bg-net">
        <div class="tile-label">Total Value (Net Landing)</div>
        <div class="tile-value">â‚¹${totalNet.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</div>
        <div class="tile-foot">Sum of Net Landing for filtered rows</div>
      </div>`;
}

function updateSummaryTable(){
    const bucketNames = {
        overall:'Overall',
        last30:'Last 30 Days',
        last60:'Last 60 Days (31â€“60)',
        last90:'Last 90 Days (61â€“90)',
        last120:'Last 120 Days (91â€“120)',
        last180:'Last 180 Days (121â€“180)',
        last360:'Last 360 Days (181â€“360)',
        oldstock:'Old Stock (360+)'
    };

    const valCol = selectedValueType==='cost'?columnMap['cost']:columnMap['net landing'];
    const valLabel = selectedValueType==='cost'?'Cost':'Net Landing';
    const unitCol = columnMap['product unit'];
    const qtyCol = columnMap['stockqty'];

    const bucketsToShow = selectedBuckets.includes('overall') ? ['overall'] : selectedBuckets.slice();

    let html = '<thead><tr><th>Ageing Bucket</th><th class="text-right">Qty (PCS)</th>';
    if(hasMCMData) html+='<th class="text-right">Qty (MCM)</th>';
    html+=`<th class="text-right">Total Value (${valLabel})</th></tr></thead><tbody>`;

    bucketsToShow.forEach(b=>{
        let rows = b==='overall' ? parsedData : parsedData.filter(r=>r._ageBucket===b);
        rows = filterBySpecificGrouping(rows);
        
        const qtyPCS = rows.filter(r=>r[unitCol]?.toUpperCase().trim()==='PCS')
                           .reduce((s,r)=>s+Number(r[qtyCol]||0),0);
        const qtyMCM = rows.filter(r=>r[unitCol]?.toUpperCase().trim()==='MCM')
                           .reduce((s,r)=>s+Number(r[qtyCol]||0),0);
        const totalV = rows.reduce((s,r)=>s+Number(r[valCol]||0),0);

        html+=`<tr>
            <td>${bucketNames[b]}</td>
            <td class="text-right">${qtyPCS.toLocaleString()}</td>
            ${hasMCMData?`<td class="text-right">${qtyMCM.toLocaleString()}</td>`:''}
            <td class="text-right">â‚¹${totalV.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</td>
        </tr>`;
    });

    html+='</tbody>';
    document.getElementById('summaryTable').innerHTML=html;
}

function updateDetailTable(){
    let data = filterByBuckets(parsedData);
    data = filterBySpecificGrouping(data);
    
    const groupCol = columnMap[currentGrouping];
    const qtyCol = columnMap['stockqty'];
    const unitCol = columnMap['product unit'];
    const costCol = columnMap['cost'];
    const netCol = columnMap['net landing'];

    const grouped = {};
    data.forEach(r=>{
        const key = String(r[groupCol]||'Unknown').trim();
        if(!grouped[key]){
            grouped[key] = {
                last30:{pcs:0,mcm:0,cost:0,net:0},
                last60:{pcs:0,mcm:0,cost:0,net:0},
                last90:{pcs:0,mcm:0,cost:0,net:0},
                last120:{pcs:0,mcm:0,cost:0,net:0},
                last180:{pcs:0,mcm:0,cost:0,net:0},
                last360:{pcs:0,mcm:0,cost:0,net:0},
                oldstock:{pcs:0,mcm:0,cost:0,net:0},
                issues:[]
            };
        }
        const b = r._ageBucket;
        const qty = Number(r[qtyCol]||0);
        const cost = Number(r[costCol]||0);
        const net  = Number(r[netCol]||0);
        const u = r[unitCol]?.toUpperCase().trim();

        if(u==='PCS') grouped[key][b].pcs += qty;
        else if(u==='MCM') grouped[key][b].mcm += qty;

        grouped[key][b].cost += cost;
        grouped[key][b].net  += net;

        if(qty<0 || cost<0 || net<0) grouped[key].issues.push('Negative');
    });

    const bucketLabels = {
        last30:'LAST 30',
        last60:'31â€“60',
        last90:'61â€“90',
        last120:'91â€“120',
        last180:'121â€“180',
        last360:'181â€“360',
        oldstock:'OLD STOCK'
    };

    const bucketsToShow = selectedBuckets.includes('overall')
        ? ['last30','last60','last90','last120','last180','last360','oldstock']
        : selectedBuckets.filter(b=>b!=='overall');

    let html = '<thead><tr><th>Group Name</th><th class="text-right">Qty (PCS)</th>';
    if(hasMCMData) html+='<th class="text-right">Qty (MCM)</th>';
    bucketsToShow.forEach(b=>{
        html+=`<th class="text-right">${bucketLabels[b]} (${selectedValueType==='cost'?'Cost':'Net'})</th>`;
    });
    html+='<th>Issues</th></tr></thead><tbody>';

    Object.keys(grouped).sort().forEach(name=>{
        const g = grouped[name];
        const totalPCS = bucketsToShow.reduce((s,b)=>s+g[b].pcs,0);
        const totalMCM = bucketsToShow.reduce((s,b)=>s+g[b].mcm,0);

        html+=`<tr><td>${name}</td><td class="text-right">${totalPCS.toLocaleString()}</td>`;
        if(hasMCMData) html+=`<td class="text-right">${totalMCM.toLocaleString()}</td>`;

        bucketsToShow.forEach(b=>{
            const val = selectedValueType==='cost'?g[b].cost:g[b].net;
            const cls = 'text-right'+(val<0?' text-danger':'');
            html+=`<td class="${cls}">â‚¹${val.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</td>`;
        });

        html+=`<td>${g.issues.length?'<span class="badge">âš  Issues</span>':''}</td></tr>`;
    });

    html+='</tbody>';
    document.getElementById('ageingTable').innerHTML=html;
}

/* Copy as image â€“ hide button in capture */
function copySectionImage(sectionId){
    const section = document.getElementById(sectionId);
    const btns = section.querySelectorAll('.copy-btn');
    btns.forEach(b=>b.classList.add('hidden'));   // hide buttons

    html2canvas(section,{scale:2}).then(canvas=>{
        btns.forEach(b=>b.classList.remove('hidden')); // show again

        canvas.toBlob(blob=>{
            if(!blob){ alert('Unable to copy'); return; }
            const item = new ClipboardItem({'image/png':blob});
            navigator.clipboard.write([item]).then(()=>{
                alert('Image copied to clipboard');
            }).catch(err=>{
                alert('Copy failed: '+err);
            });
        });
    });
}
</script>
</body>
</html>
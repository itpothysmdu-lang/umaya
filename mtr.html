<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Transfer Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #ddd;
            position: relative;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 16px;
            margin-bottom: 20px;
        }
        
        .date-range {
            font-size: 18px;
            font-weight: 600;
            color: #2980b9;
            background-color: #ecf0f1;
            padding: 12px 20px;
            border-radius: 8px;
            display: inline-block;
            margin-bottom: 20px;
        }
        
        .upload-section {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .upload-area {
            border: 2px dashed #3498db;
            border-radius: 8px;
            padding: 40px 20px;
            margin-top: 20px;
            background-color: #f8fafc;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            background-color: #e8f4fc;
            border-color: #2980b9;
        }
        
        .upload-icon {
            font-size: 48px;
            color: #3498db;
            margin-bottom: 15px;
        }
        
        .file-input {
            display: none;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .mode-selector {
            display: flex;
            gap: 10px;
        }
        
        .mode-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background-color: #ecf0f1;
            color: #7f8c8d;
        }
        
        .mode-btn.active {
            background-color: #3498db;
            color: white;
        }
        
        .mode-btn:hover:not(.active) {
            background-color: #d5dbdb;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .action-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background-color: #2ecc71;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .action-btn:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
        }
        
        .action-btn.secondary {
            background-color: #9b59b6;
        }
        
        .action-btn.secondary:hover {
            background-color: #8e44ad;
        }
        
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin: 10px 0;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .division-textiles { border-left: 5px solid #e74c3c; }
        .division-gents { border-left: 5px solid #3498db; }
        .division-jewellery { border-left: 5px solid #f39c12; }
        .division-ladies { border-left: 5px solid #9b59b6; }
        .division-furnishing { border-left: 5px solid #1abc9c; }
        .division-fabrics { border-left: 5px solid #e67e22; }
        .division-kids { border-left: 5px solid #964e63; }
        
        .table-container {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            overflow-x: auto;
            margin-bottom: 30px;
            position: relative;
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background-color: #2c3e50;
            color: white;
        }
        
        th {
            padding: 16px 12px;
            text-align: center;
            font-weight: 600;
        }
        
        tbody tr {
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }
        
        tbody tr:hover {
            background-color: #f9f9f9;
        }
        
        td {
            padding: 14px 12px;
            text-align: center;
        }
        
        .total-row {
            background-color: #e3f2fd !important; /* Light blue background */
            font-weight: 700;
            border-top: 2px solid #2196f3;
        }
        
        .division-cell {
            font-weight: 600;
            display: flex;
            align-items: center;
            text-align: left;
        }
        
        .division-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .mtr-qty-cell {
            font-weight: 500;
        }
        
        .positive {
            color: #27ae60;
        }
        
        .negative {
            color: #e74c3c;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #7f8c8d;
        }
        
        .loading i {
            font-size: 36px;
            margin-bottom: 15px;
            color: #3498db;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            background-color: #2ecc71;
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .notification.error {
            background-color: #e74c3c;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            color: #95a5a6;
            font-size: 14px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .report-container {
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .report-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #3498db;
        }
        
        .report-title {
            color: #2c3e50;
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .report-date {
            color: #7f8c8d;
            font-size: 18px;
            font-weight: 600;
        }
        
        .date-range-info {
            color: #7f8c8d;
            font-size: 14px;
            font-weight: 600;
            background-color: #f0f8ff;
            padding: 8px 15px;
            border-radius: 6px;
            border-left: 4px solid #3498db;
        }
        
        @media (max-width: 992px) {
            .controls {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .mode-selector {
                width: 100%;
                justify-content: space-between;
                margin-bottom: 15px;
            }
            
            .mode-btn {
                flex: 1;
                text-align: center;
            }
            
            .action-buttons {
                width: 100%;
                justify-content: flex-end;
            }
        }
        
        @media (max-width: 768px) {
            .stats-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .upload-area {
                padding: 30px 15px;
            }
            
            .table-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .action-buttons {
                width: 100%;
                justify-content: center;
            }
            
            th, td {
                padding: 10px 8px;
                font-size: 14px;
            }
        }
        
        @media (max-width: 480px) {
            .stats-cards {
                grid-template-columns: 1fr;
            }
            
            .mode-selector {
                flex-direction: column;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="date-range" id="dateRange">Date Range: Upload Excel file to see data</div>
        </header>
        
        <section class="upload-section">
            <h2>Upload Excel File</h2>
            
            
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">
                    <i class="fas fa-file-excel"></i>
                </div>
                <h3>Click to select Excel file or drag and drop here</h3>
                <input type="file" id="excelFile" class="file-input" accept=".xlsx,.xls,.csv">
            </div>
            
           
        </section>
        
        <div class="loading" id="loadingIndicator">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Processing Excel file...</p>
        </div>
        
        <div class="controls">
            <div class="mode-selector">
                <button class="mode-btn active" id="fullPeriodBtn">Full Period</button>
                <button class="mode-btn" id="lastDateBtn">Last Date Only</button>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" id="copyReportBtn">
                    <i class="fas fa-camera"></i> Copy Report as Image
                </button>
                <button class="action-btn secondary" id="copyTableBtn">
                    <i class="fas fa-table"></i> Copy Table as Image
                </button>
            </div>
        </div>
        
        <!-- Report Container for Screenshot -->
        <div class="report-container" id="reportContainer">
            <div class="report-header">
                <div class="report-title">Mdu Open Wh To Shop Stock Qty TR Status</div>
                <div class="report-date" id="reportDateRange">Date Range: No data loaded</div>
            </div>
            
            <div class="stats-cards" id="summaryCards">
                <!-- Summary cards will be dynamically inserted here -->
            </div>
            
            <div class="table-container" id="tableContainer">
                <div class="table-header">
                    <h2>Mdu Open Wh To Shop Stock Qty TR Status</h2>
                    <div class="date-range-info" id="tableDateRangeInfo">
                        Date Range: Select Days
                    </div>
                </div>
                <table id="summaryTable">
                    <thead>
                        <tr>
                            <th>DIVISION</th>
                            <th>TRANSFER PCS</th>
                            <th>TRANSFER MTR / QTY</th>
                            <th>PENDING PCS</th>
                            <th>PENDING MTR / QTY</th>
                            <th>RECEIVED PCS</th>
                            <th>RECEIVED MTR / QTY</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Table rows will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <footer>
            <p>Dashboard for Excel Stock Transfer Analysis | Built with HTML, CSS & JavaScript</p>
            <p style="margin-top: 5px; font-size: 12px;">Use the camera buttons to copy reports as images to clipboard</p>
        </footer>
        
        <!-- Notification for screenshot -->
        <div class="notification" id="notification">
            Report copied to clipboard!
        </div>
    </div>

    <script>
        // Global variables
        let workbookData = null;
        let currentMode = 'fullPeriod'; // 'fullPeriod' or 'lastDate'
        let allSheetData = [];
        let dateRange = { min: null, max: null };
        
        // DOM Elements
        const excelFileInput = document.getElementById('excelFile');
        const uploadArea = document.getElementById('uploadArea');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const dateRangeElement = document.getElementById('dateRange');
        const reportDateRange = document.getElementById('reportDateRange');
        const tableDateRangeInfo = document.getElementById('tableDateRangeInfo');
        const fullPeriodBtn = document.getElementById('fullPeriodBtn');
        const lastDateBtn = document.getElementById('lastDateBtn');
        const tableBody = document.getElementById('tableBody');
        const summaryCards = document.getElementById('summaryCards');
        const copyReportBtn = document.getElementById('copyReportBtn');
        const copyTableBtn = document.getElementById('copyTableBtn');
        const reportContainer = document.getElementById('reportContainer');
        const tableContainer = document.getElementById('tableContainer');
        const notification = document.getElementById('notification');
        
        // Event Listeners
        excelFileInput.addEventListener('change', handleFileUpload);
        uploadArea.addEventListener('click', () => excelFileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#2980b9';
            uploadArea.style.backgroundColor = '#e8f4fc';
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = '#3498db';
            uploadArea.style.backgroundColor = '#f8fafc';
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#3498db';
            uploadArea.style.backgroundColor = '#f8fafc';
            
            if (e.dataTransfer.files.length) {
                excelFileInput.files = e.dataTransfer.files;
                handleFileUpload();
            }
        });
        
        fullPeriodBtn.addEventListener('click', () => {
            setActiveMode('fullPeriod');
            renderSummaryTable();
            updateDateRangeDisplay();
            updateReportDateRange();
            updateTableDateRangeInfo();
        });
        
        lastDateBtn.addEventListener('click', () => {
            setActiveMode('lastDate');
            renderSummaryTable();
            updateDateRangeDisplay();
            updateReportDateRange();
            updateTableDateRangeInfo();
        });
        
        copyReportBtn.addEventListener('click', () => copyReportToClipboard('reportContainer'));
        copyTableBtn.addEventListener('click', () => copyReportToClipboard('tableContainer'));
        
        // Parse MTR(QTY) string like "234.60 (20)" into {mtr: 234.60, qty: 20}
        function parseMtrQty(value) {
            if (!value) return { mtr: 0, qty: 0 };
            
            const strValue = String(value).trim();
            
            // Handle cases where value might be just a number
            if (!isNaN(strValue) && !strValue.includes('(')) {
                return { mtr: parseFloat(strValue) || 0, qty: 0 };
            }
            
            // Extract the numeric part before the space (meters)
            const mtrMatch = strValue.match(/^([\d.]+)/);
            // Extract the number inside parentheses (quantity)
            const qtyMatch = strValue.match(/\((\d+)\)/);
            
            const mtr = mtrMatch ? parseFloat(mtrMatch[1]) : 0;
            const qty = qtyMatch ? parseInt(qtyMatch[1]) : 0;
            
            return { mtr, qty };
        }
        
        // Convert Excel date to JavaScript Date
        function excelDateToJSDate(excelDate) {
            if (!excelDate) return null;
            
            // If it's already a Date object
            if (excelDate instanceof Date) return excelDate;
            
            // If it's a string, try to parse it
            if (typeof excelDate === 'string') {
                // Try different date formats
                const dateFormats = [
                    /(\d{1,2})[-/](\d{1,2})[-/](\d{2,4})/, // dd-mm-yyyy or mm/dd/yyyy
                    /(\d{4})[-/](\d{1,2})[-/](\d{1,2})/,   // yyyy-mm-dd
                ];
                
                for (const format of dateFormats) {
                    const match = excelDate.match(format);
                    if (match) {
                        let day, month, year;
                        
                        if (match[1].length === 4) {
                            // yyyy-mm-dd format
                            year = parseInt(match[1]);
                            month = parseInt(match[2]) - 1;
                            day = parseInt(match[3]);
                        } else {
                            // dd-mm-yyyy or mm/dd/yyyy format
                            day = parseInt(match[1]);
                            month = parseInt(match[2]) - 1;
                            year = parseInt(match[3]);
                            
                            // Handle 2-digit years
                            if (year < 100) {
                                year = year + 2000; // Assuming 2000s
                            }
                        }
                        
                        const date = new Date(year, month, day);
                        if (!isNaN(date.getTime())) return date;
                    }
                }
                
                // If string parsing fails, return null
                return null;
            }
            
            // If it's a number (Excel serial date)
            if (typeof excelDate === 'number') {
                const excelEpoch = new Date(1899, 11, 30);
                const jsDate = new Date(excelEpoch.getTime() + excelDate * 24 * 60 * 60 * 1000);
                return jsDate;
            }
            
            return null;
        }
        
        // Format date as dd-mm-yyyy
        function formatDate(date) {
            if (!date) return 'N/A';
            
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            
            return `${day}-${month}-${year}`;
        }
        
        // Set active mode
        function setActiveMode(mode) {
            currentMode = mode;
            
            if (mode === 'fullPeriod') {
                fullPeriodBtn.classList.add('active');
                lastDateBtn.classList.remove('active');
            } else {
                lastDateBtn.classList.add('active');
                fullPeriodBtn.classList.remove('active');
            }
        }
        
        // Update date range display
        function updateDateRangeDisplay() {
            if (!dateRange.min || !dateRange.max) {
                dateRangeElement.textContent = 'Date Range: Upload Excel file to see data';
                return;
            }
            
            if (currentMode === 'fullPeriod') {
                dateRangeElement.textContent = `Date Range: ${formatDate(dateRange.min)} to ${formatDate(dateRange.max)}`;
            } else {
                dateRangeElement.textContent = `Date Range: ${formatDate(dateRange.max)} only`;
            }
        }
        
        // Update report date range
        function updateReportDateRange() {
            if (!dateRange.min || !dateRange.max) {
                reportDateRange.textContent = 'Date Range: No data loaded';
                return;
            }
            
            if (currentMode === 'fullPeriod') {
                reportDateRange.textContent = `Date Range: ${formatDate(dateRange.min)} to ${formatDate(dateRange.max)}`;
            } else {
                reportDateRange.textContent = `Date Range: ${formatDate(dateRange.max)} only`;
            }
        }
        
        // Update table date range info
        function updateTableDateRangeInfo() {
            if (!dateRange.min || !dateRange.max) {
                tableDateRangeInfo.textContent = 'Date Range: Select Days';
                return;
            }
            
            if (currentMode === 'fullPeriod') {
                tableDateRangeInfo.textContent = `Date Range: ${formatDate(dateRange.min)} to ${formatDate(dateRange.max)}`;
            } else {
                tableDateRangeInfo.textContent = `Date Range: ${formatDate(dateRange.max)} only`;
            }
        }
        
        // Show notification
        function showNotification(message, isError = false) {
            notification.textContent = message;
            notification.classList.remove('error');
            
            if (isError) {
                notification.classList.add('error');
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Copy report/table to clipboard as image
        function copyReportToClipboard(elementId) {
            if (!workbookData) {
                showNotification('Please upload an Excel file first', true);
                return;
            }
            
            const element = document.getElementById(elementId);
            
            // Temporarily hide action buttons in the screenshot
            const originalActionButtons = document.querySelector('.action-buttons').style.display;
            document.querySelector('.action-buttons').style.display = 'none';
            
            // Temporarily adjust report container width for better screenshot
            const originalWidth = element.style.width;
            element.style.width = '100%';
            
            html2canvas(element, {
                scale: 2, // Higher resolution
                backgroundColor: '#ffffff',
                useCORS: true,
                logging: false
            }).then(canvas => {
                // Restore original styles
                document.querySelector('.action-buttons').style.display = originalActionButtons;
                element.style.width = originalWidth;
                
                canvas.toBlob(blob => {
                    const item = new ClipboardItem({ "image/png": blob });
                    navigator.clipboard.write([item]).then(() => {
                        const elementName = elementId === 'reportContainer' ? 'Full Report' : 'Summary Table';
                        showNotification(`${elementName} copied to clipboard!`);
                    }).catch(err => {
                        console.error('Failed to copy image: ', err);
                        showNotification('Failed to copy image to clipboard', true);
                    });
                });
            }).catch(err => {
                console.error('Failed to capture screenshot: ', err);
                showNotification('Failed to capture screenshot', true);
                
                // Restore original styles even on error
                document.querySelector('.action-buttons').style.display = originalActionButtons;
                element.style.width = originalWidth;
            });
        }
        
        // Process uploaded Excel file
        async function handleFileUpload() {
            const file = excelFileInput.files[0];
            if (!file) return;
            
            // Validate file type
            const validExtensions = ['.xlsx', '.xls', '.csv'];
            const fileExtension = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
            
            if (!validExtensions.includes(fileExtension)) {
                showNotification('Please upload a valid Excel file (.xlsx, .xls, .csv)', true);
                return;
            }
            
            // Show loading indicator
            loadingIndicator.style.display = 'block';
            uploadArea.style.opacity = '0.5';
            
            try {
                const data = await readExcelFile(file);
                workbookData = data;
                processWorkbookData(data);
                renderSummaryTable();
                updateDateRangeDisplay();
                updateReportDateRange();
                updateTableDateRangeInfo();
                createSummaryCards();
                
                // Show success message
                showNotification(`File "${file.name}" loaded successfully!`);
            } catch (error) {
                console.error('Error processing file:', error);
                showNotification(`Error processing file: ${error.message}`, true);
            } finally {
                // Hide loading indicator
                loadingIndicator.style.display = 'none';
                uploadArea.style.opacity = '1';
            }
        }
        
        // Read Excel file using SheetJS
        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        resolve(workbook);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = function() {
                    reject(new Error('Failed to read file'));
                };
                
                reader.readAsArrayBuffer(file);
            });
        }
        
        // Process workbook data
        function processWorkbookData(workbook) {
            allSheetData = [];
            dateRange.min = null;
            dateRange.max = null;
            
            // Define expected sheet names (divisions)
            const expectedSheets = [
                'textiles', 'gents', 'jewellery', 'ladies', 
                'furnishing', 'fabrics', 'other', 'accessories'
            ];
            
            // Process each sheet
            workbook.SheetNames.forEach(sheetName => {
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                if (jsonData.length < 2) return; // Skip empty sheets
                
                // Extract headers (first row)
                const headers = jsonData[0].map(h => String(h).toLowerCase().trim());
                
                // Find column indices
                const colIndices = {
                    sno: headers.indexOf('sno'),
                    entryno: headers.indexOf('entryno'),
                    entrydate: headers.indexOf('entrydate'),
                    bundleBarcode: headers.indexOf('bundle barcode'),
                    pcsQty: headers.indexOf('pcs qty'),
                    mtrQty: headers.indexOf('mtr(qty)'),
                    pendingQty: headers.indexOf('pending qty'),
                    receivingQty: headers.indexOf('receiving qty'),
                    receivingMtr: headers.indexOf('receiving mtr')
                };
                
                // Check if required columns exist
                const missingColumns = [];
                if (colIndices.entrydate === -1) missingColumns.push('ENTRYDATE');
                if (colIndices.pcsQty === -1) missingColumns.push('PCS QTY');
                if (colIndices.mtrQty === -1) missingColumns.push('MTR(QTY)');
                if (colIndices.pendingQty === -1) missingColumns.push('PENDING QTY');
                if (colIndices.receivingQty === -1) missingColumns.push('RECEIVING QTY');
                if (colIndices.receivingMtr === -1) missingColumns.push('RECEIVING MTR');
                
                if (missingColumns.length > 0) {
                    console.warn(`Sheet "${sheetName}" missing columns: ${missingColumns.join(', ')}`);
                }
                
                // Process rows (skip header row)
                const rows = [];
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (!row || row.length === 0) continue;
                    
                    const entryDate = excelDateToJSDate(row[colIndices.entrydate]);
                    
                    // Update global date range
                    if (entryDate) {
                        if (!dateRange.min || entryDate < dateRange.min) {
                            dateRange.min = entryDate;
                        }
                        if (!dateRange.max || entryDate > dateRange.max) {
                            dateRange.max = entryDate;
                        }
                    }
                    
                    // Parse MTR(QTY) column
                    const mtrQtyValue = row[colIndices.mtrQty] || 0;
                    const parsedMtrQty = parseMtrQty(mtrQtyValue);
                    
                    // Parse RECEIVING MTR column
                    const receivingMtrValue = row[colIndices.receivingMtr] || 0;
                    const parsedReceivingMtr = parseMtrQty(receivingMtrValue);
                    
                    // Get PCS QTY value
                    const pcsQty = parseFloat(row[colIndices.pcsQty]) || 0;
                    
                    // Get PENDING QTY value
                    const pendingQty = parseFloat(row[colIndices.pendingQty]) || 0;
                    
                    // Calculate RECEIVED PCS based on PENDING QTY
                    // If PENDING QTY is negative, RECEIVED PCS = PCS QTY + |PENDING QTY|
                    // Otherwise, RECEIVED PCS = PCS QTY - PENDING QTY (but ensure not negative)
                    let receivedPcs = 0;
                    if (pendingQty < 0) {
                        // Negative pending means received more than transferred
                        receivedPcs = pcsQty + Math.abs(pendingQty);
                    } else {
                        // Positive or zero pending means received less than or equal to transferred
                        receivedPcs = Math.max(0, pcsQty - pendingQty);
                    }
                    
                    // Calculate RECEIVED MTR/QTY based on PENDING QTY
                    // If PENDING QTY is negative, RECEIVED MTR/QTY = MTR(QTY) + |PENDING MTR/QTY|
                    // This is complex - for now, we'll use the parsed receiving values
                    // but adjust based on your explanation
                    let receivedMtr = 0;
                    let receivedQty = 0;
                    
                    // If we have actual receiving values from the sheet, use them
                    if (parsedReceivingMtr.mtr > 0 || parsedReceivingMtr.qty > 0) {
                        receivedMtr = parsedReceivingMtr.mtr;
                        receivedQty = parsedReceivingMtr.qty;
                    } else {
                        // If no receiving values, estimate based on transfer and pending
                        // This is a simplified approach
                        receivedMtr = Math.max(0, parsedMtrQty.mtr - (pendingQty < 0 ? -pendingQty : pendingQty));
                        receivedQty = Math.max(0, parsedMtrQty.qty - (pendingQty < 0 ? -pendingQty : pendingQty));
                    }
                    
                    rows.push({
                        entryDate: entryDate,
                        pcsQty: pcsQty,
                        mtrQty: mtrQtyValue,
                        mtrValue: parsedMtrQty.mtr,
                        qtyValue: parsedMtrQty.qty,
                        pendingQty: pendingQty,
                        // Calculate pending mtr/qty based on transfer minus received
                        pendingMtrValue: Math.max(0, parsedMtrQty.mtr - receivedMtr),
                        pendingQtyValue: Math.max(0, parsedMtrQty.qty - receivedQty),
                        // Using calculated received values
                        receivedPcs: receivedPcs,
                        receivedMtr: receivedMtr,
                        receivedQty: receivedQty
                    });
                }
                
                // Store sheet data
                allSheetData.push({
                    name: sheetName,
                    rows: rows
                });
            });
        }
        
        // Calculate summary for a division
        function calculateDivisionSummary(sheetData) {
            const { name, rows } = sheetData;
            
            // Filter rows based on current mode
            let filteredRows = rows;
            if (currentMode === 'lastDate' && dateRange.max) {
                filteredRows = rows.filter(row => {
                    if (!row.entryDate) return false;
                    return formatDate(row.entryDate) === formatDate(dateRange.max);
                });
            }
            
            // Initialize totals
            let transferPcs = 0;
            let transferMtr = 0;
            let transferQty = 0;
            let pendingPcs = 0;
            let pendingMtr = 0;
            let pendingQty = 0;
            let receivedPcs = 0;
            let receivedMtr = 0;
            let receivedQty = 0;
            
            // Calculate totals
            filteredRows.forEach(row => {
                transferPcs += row.pcsQty;
                transferMtr += row.mtrValue;
                transferQty += row.qtyValue;
                pendingPcs += row.pendingQty;
                pendingMtr += row.pendingMtrValue;
                pendingQty += row.pendingQtyValue;
                receivedPcs += row.receivedPcs;
                receivedMtr += row.receivedMtr;
                receivedQty += row.receivedQty;
            });
            
            // Ensure pending values are not negative
            if (pendingMtr < 0) pendingMtr = 0;
            if (pendingQty < 0) pendingQty = 0;
            
            return {
                division: name,
                transferPcs,
                transferMtr,
                transferQty,
                pendingPcs,
                pendingMtr,
                pendingQty,
                receivedPcs,
                receivedMtr,
                receivedQty
            };
        }
        
        // Render summary table
        function renderSummaryTable() {
            if (!workbookData || allSheetData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">No data available. Please upload an Excel file.</td></tr>';
                return;
            }
            
            tableBody.innerHTML = '';
            
            // Calculate summaries for all divisions
            const summaries = allSheetData.map(sheetData => calculateDivisionSummary(sheetData));
            
            // Calculate grand totals
            const grandTotals = {
                transferPcs: 0,
                transferMtr: 0,
                transferQty: 0,
                pendingPcs: 0,
                pendingMtr: 0,
                pendingQty: 0,
                receivedPcs: 0,
                receivedMtr: 0,
                receivedQty: 0
            };
            
            // Add rows for each division
            summaries.forEach(summary => {
                // Update grand totals
                grandTotals.transferPcs += summary.transferPcs;
                grandTotals.transferMtr += summary.transferMtr;
                grandTotals.transferQty += summary.transferQty;
                grandTotals.pendingPcs += summary.pendingPcs;
                grandTotals.pendingMtr += summary.pendingMtr;
                grandTotals.pendingQty += summary.pendingQty;
                grandTotals.receivedPcs += summary.receivedPcs;
                grandTotals.receivedMtr += summary.receivedMtr;
                grandTotals.receivedQty += summary.receivedQty;
                
                // Create row
                const row = document.createElement('tr');
                row.className = `division-${summary.division.toLowerCase()}`;
                
                // Division colors
                const divisionColors = {
                    'textiles': '#e74c3c',
                    'gents': '#3498db',
                    'jewellery': '#f39c12',
                    'ladies': '#9b59b6',
                    'furnishing': '#1abc9c',
                    'fabrics': '#e67e22',
                    'kids': '#964e63',
                    'accessories': '#34495e'
                };
                
                const color = divisionColors[summary.division.toLowerCase()] || '#95a5a6';
                
                row.innerHTML = `
                    <td class="division-cell">
                        <span class="division-color" style="background-color: ${color}"></span>
                        ${summary.division.toUpperCase()}
                    </td>
                    <td>${summary.transferPcs.toLocaleString()}</td>
                    <td class="mtr-qty-cell">${summary.transferMtr.toFixed(2)} / ${summary.transferQty}</td>
                    <td>${summary.pendingPcs.toLocaleString()}</td>
                    <td class="mtr-qty-cell">${summary.pendingMtr.toFixed(2)} / ${summary.pendingQty}</td>
                    <td>${summary.receivedPcs.toLocaleString()}</td>
                    <td class="mtr-qty-cell">${summary.receivedMtr.toFixed(2)} / ${summary.receivedQty}</td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Add grand total row
            const totalRow = document.createElement('tr');
            totalRow.className = 'total-row';
            totalRow.innerHTML = `
                <td>TOTAL</td>
                <td>${grandTotals.transferPcs.toLocaleString()}</td>
                <td class="mtr-qty-cell">${grandTotals.transferMtr.toFixed(2)} / ${grandTotals.transferQty}</td>
                <td>${grandTotals.pendingPcs.toLocaleString()}</td>
                <td class="mtr-qty-cell">${grandTotals.pendingMtr.toFixed(2)} / ${grandTotals.pendingQty}</td>
                <td>${grandTotals.receivedPcs.toLocaleString()}</td>
                <td class="mtr-qty-cell">${grandTotals.receivedMtr.toFixed(2)} / ${grandTotals.receivedQty}</td>
            `;
            tableBody.appendChild(totalRow);
        }
        
        // Create summary cards
        function createSummaryCards() {
            if (!workbookData || allSheetData.length === 0) {
                summaryCards.innerHTML = '';
                return;
            }
            
            // Calculate summaries for all divisions
            const summaries = allSheetData.map(sheetData => calculateDivisionSummary(sheetData));
            
            // Calculate totals
            const totals = {
                transferPcs: summaries.reduce((sum, s) => sum + s.transferPcs, 0),
                transferMtr: summaries.reduce((sum, s) => sum + s.transferMtr, 0),
                transferQty: summaries.reduce((sum, s) => sum + s.transferQty, 0),
                pendingPcs: summaries.reduce((sum, s) => sum + s.pendingPcs, 0),
                pendingMtr: summaries.reduce((sum, s) => sum + s.pendingMtr, 0),
                pendingQty: summaries.reduce((sum, s) => sum + s.pendingQty, 0),
                receivedPcs: summaries.reduce((sum, s) => sum + s.receivedPcs, 0),
                receivedMtr: summaries.reduce((sum, s) => sum + s.receivedMtr, 0),
                receivedQty: summaries.reduce((sum, s) => sum + s.receivedQty, 0)
            };
            
            // Calculate completion percentage
            const completionRate = totals.transferMtr > 0 ? 
                (totals.receivedMtr / totals.transferMtr * 100).toFixed(1) : 0;
            
            // Calculate pending percentage
            const pendingRate = totals.transferMtr > 0 ? 
                (totals.pendingMtr / totals.transferMtr * 100).toFixed(1) : 0;
            
            summaryCards.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">TOTAL DIVISIONS</div>
                    <div class="stat-value">${allSheetData.length}</div>
                    <div class="stat-detail">Excel Sheets Processed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">TOTAL TRANSFER PCS</div>
                    <div class="stat-value">${totals.transferPcs.toLocaleString()}</div>
                    <div class="stat-detail">Total Pieces</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">TOTAL TRANSFER MTR/QTY</div>
                    <div class="stat-value">${totals.transferMtr.toFixed(2)} / ${totals.transferQty}</div>
                    <div class="stat-detail">Total Meters / Quantity</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">COMPLETION RATE</div>
                    <div class="stat-value">${completionRate}%</div>
                    <div class="stat-detail">${totals.receivedMtr.toFixed(2)} / ${totals.transferMtr.toFixed(2)} MTR</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">PENDING RATE</div>
                    <div class="stat-value">${pendingRate}%</div>
                    <div class="stat-detail">${totals.pendingMtr.toFixed(2)} / ${totals.transferMtr.toFixed(2)} MTR</div>
                </div>
            `;
        }
        
        // Initialize the dashboard
        window.addEventListener('DOMContentLoaded', () => {
            console.log('Dashboard initialized. Ready to accept Excel files.');
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Stock Position Report</title>

<style>
 body { font-family: Arial, sans-serif; margin: 20px; }
 h2 { margin-top: 32px; }
 table { border-collapse: collapse; width: 100%; margin-top: 12px; }
 th, td { border: 1px solid #ccc; padding: 6px; text-align: right; }
 th { background:#f3f3f3; text-align:center; }
 .totals { font-weight:bold; background:#eef; }
 .section { border:1px solid #ddd; padding:16px; border-radius:10px; margin-top:18px;}
 label { display:block; margin:6px 0 3px; }
 input, select { padding:6px; width:100%; box-sizing:border-box; }
 .grid { display:grid; grid-template-columns:repeat(2,1fr); gap:14px;}
 button { padding:10px 18px; margin-top:18px; cursor:pointer;}
 .report-block { background:#fafafa; padding:14px; border-radius:10px; margin-top:12px;}
 .highlight { color:#b30000; font-weight:bold;}
 
 /* Additional styles for report table */
 .report-block table {
   width: 100%;
   margin-top: 15px;
   background: white;
 }
 
 .report-block th {
   background: #4a6fa5;
   color: white;
   text-align: left;
   padding: 10px;
 }
 
 .report-block td {
   padding: 8px 10px;
   border-bottom: 1px solid #eee;
   text-align: left;
 }
 
 .report-block tr:hover {
   background: #f9f9f9;
 }
 
 .copy-btn {
   background: #28a745;
   color: white;
   border: none;
   padding: 10px 20px;
   border-radius: 5px;
   cursor: pointer;
   margin-top: 15px;
   font-size: 14px;
   margin-right: 10px;
 }
 
 .copy-btn:hover {
   background: #218838;
 }
 
 .header-info {
   background: #f0f7ff;
   padding: 15px;
   border-radius: 8px;
   margin-bottom: 20px;
   border-left: 4px solid #4a6fa5;
 }
 
 .header-info-grid {
   display: grid;
   grid-template-columns: repeat(4, 1fr);
   gap: 20px;
 }
 
 .header-info-item {
   margin-bottom: 10px;
 }
 
 .header-info-label {
   font-weight: bold;
   color: #555;
   font-size: 14px;
 }
 
 .header-info-value {
   font-size: 16px;
   color: #333;
   margin-top: 5px;
 }
 
 .button-container {
   display: flex;
   flex-wrap: wrap;
   gap: 10px;
   margin-top: 20px;
 }
 
 .report-type-badge {
   display: inline-block;
   padding: 4px 12px;
   background: #4a6fa5;
   color: white;
   border-radius: 20px;
   font-size: 12px;
   margin-left: 10px;
   font-weight: normal;
 }
</style>
</head>

<body>
<h1>STOCK POSITION REPORT</h1>

<div class="section">
  <h3>Report Filters & Parameters</h3>
  <div class="grid">
    <div>
      <label>From Date *</label>
      <input type="date" id="fromDate" required>
    </div>
    <div>
      <label>To Date *</label>
      <input type="date" id="toDate" required>
    </div>
    <div>
      <label>Purchaser Name</label>
      <input type="text" id="purchaser" placeholder="Enter purchaser name">
    </div>
    <div>
      <label>Location</label>
      <input type="text" id="location" placeholder="Enter location">
    </div>
  </div>
  <div style="margin-top: 20px;">
    <label>Report Type</label>
    <select id="reportType">
      <option value="detailed">Detailed Report</option>
      <option value="summary">Summary Report</option>
      <option value="aging">Aging Analysis</option>
      <option value="liquidation">Liquidation Report</option>
    </select>
  </div>
</div>

<!-- Opening Stock -->
<div class="section">
  <h3>Opening Stock (As of From Date)</h3>
  <table id="openingTable">
    <thead>
      <tr>
        <th>Year</th>
        <th>PCS Qty</th><th>PCS Value</th>
        <th>MCM Qty</th><th>MCM Value</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr class="totals">
        <td>Total</td>
        <td id="opPcsQtyTot">0</td><td id="opPcsValTot">0</td>
        <td id="opMcmQtyTot">0</td><td id="opMcmValTot">0</td>
      </tr>
    </tfoot>
  </table>
</div>

<!-- Closing Stock -->
<div class="section">
  <h3>Closing Stock (As of To Date)</h3>
  <table id="closingTable">
    <thead>
      <tr>
        <th>Year</th>
        <th>PCS Qty</th><th>PCS Value</th>
        <th>MCM Qty</th><th>MCM Value</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr class="totals">
        <td>Total</td>
        <td id="clPcsQtyTot">0</td><td id="clPcsValTot">0</td>
        <td id="clMcmQtyTot">0</td><td id="clMcmValTot">0</td>
      </tr>
    </tfoot>
  </table>
</div>

<button onclick="generateReport()">Generate Report</button>

<h2>Auto-Generated Management Report</h2>
<div id="report"></div>

<script>
// Set default dates (today and tomorrow)
const today = new Date();
const tomorrow = new Date(today);
tomorrow.setDate(tomorrow.getDate() + 1);

document.getElementById('fromDate').value = today.toISOString().split('T')[0];
document.getElementById('toDate').value = tomorrow.toISOString().split('T')[0];

// ---------- helpers ----------
const years = [2021, 2022, 2023, 2024, 2025];
createRows("closingTable");
createRows("openingTable");

function createRows(tableId){
  const tbody = document.querySelector(`#${tableId} tbody`);
  years.forEach(y=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td style="text-align:center">${y}</td>
      <td><input type="number" value="0" data-type="qty" data-group="pcs"></td>
      <td><input type="number" value="0" data-type="value" data-group="pcs"></td>
      <td><input type="number" value="0" data-type="qty" data-group="mcm"></td>
      <td><input type="number" value="0" data-type="value" data-group="mcm"></td>`;
    tbody.appendChild(tr);
  });

  tbody.addEventListener("input", ()=>updateTotals(tableId));
  updateTotals(tableId);
}

function updateTotals(tableId){
  const rows = document.querySelectorAll(`#${tableId} tbody tr`);
  let pcsQty=0, pcsVal=0, mcmQty=0, mcmVal=0;
  rows.forEach(r=>{
    const tds = r.querySelectorAll("input");
    pcsQty += +tds[0].value; pcsVal += +tds[1].value;
    mcmQty += +tds[2].value; mcmVal += +tds[3].value;
  });
  const prefix = tableId==="closingTable" ? "cl" : "op";
  document.getElementById(prefix+"PcsQtyTot").innerText = pcsQty.toLocaleString();
  document.getElementById(prefix+"PcsValTot").innerText = pcsVal.toLocaleString();
  document.getElementById(prefix+"McmQtyTot").innerText = mcmQty.toLocaleString();
  document.getElementById(prefix+"McmValTot").innerText = mcmVal.toLocaleString();
}

// ---------- report generator ----------
function generateReport(){
  // Get filter values
  const fromDate = document.getElementById("fromDate").value;
  const toDate = document.getElementById("toDate").value;
  const purchaser = document.getElementById("purchaser").value || "Not Specified";
  const location = document.getElementById("location").value || "All Locations";
  const reportType = document.getElementById("reportType").value;
  
  // Validate dates
  if (!fromDate || !toDate) {
    alert("Please select both From Date and To Date");
    return;
  }
  
  const opening = readTable("openingTable");
  const closing = readTable("closingTable");
  
  // Calculate totals
  const totalOpeningPcsQty = total(opening, 'pcsQty');
  const totalOpeningMcmQty = total(opening, 'mcmQty');
  const totalOpeningPcsVal = total(opening, 'pcsVal');
  const totalOpeningMcmVal = total(opening, 'mcmVal');
  
  const totalClosingPcsQty = total(closing, 'pcsQty');
  const totalClosingMcmQty = total(closing, 'mcmQty');
  const totalClosingPcsVal = total(closing, 'pcsVal');
  const totalClosingMcmVal = total(closing, 'mcmVal');
  
  // Stock Liquidation
  const stockSoldPcs = totalOpeningPcsQty - totalClosingPcsQty;
  const stockSoldMcm = totalOpeningMcmQty - totalClosingMcmQty;
  const totalStockAvailable = totalOpeningPcsQty + totalOpeningMcmQty;
  const totalStockSold = stockSoldPcs + stockSoldMcm;
  
  // Stock Liquidation Percentage
  const stockLiquidationPercent = totalStockAvailable > 0 ? 
    ((totalStockSold / totalStockAvailable) * 100).toFixed(2) : 0;
  
  // Aging analysis
  const currentYear = Math.max(...years);
  const lastYear = currentYear - 1;
  let agingStockQty = 0;
  let agingStockValue = 0;
  let agingDetails = [];
  
  years.forEach(year => {
    if (year < lastYear) {
      const yearQty = opening[year]?.pcsQty + opening[year]?.mcmQty || 0;
      const yearValue = opening[year]?.pcsVal + opening[year]?.mcmVal || 0;
      if (yearQty > 0) {
        agingStockQty += yearQty;
        agingStockValue += yearValue;
        agingDetails.push({
          year: year,
          qty: yearQty,
          value: yearValue,
          age: currentYear - year
        });
      }
    }
  });
  
  // KPIs
  const avgStockTurnover = totalStockAvailable > 0 ? 
    (totalStockSold / totalStockAvailable).toFixed(2) : 0;
  const stockCoverageDays = totalStockSold > 0 ? 
    Math.round((totalStockAvailable / totalStockSold) * 30) : 0;
  
  // GP calculations
  const gpPercentage = 20;
  const totalOpeningValue = totalOpeningPcsVal + totalOpeningMcmVal;
  const totalClosingValue = totalClosingPcsVal + totalClosingMcmVal;
  const stockSoldValue = totalOpeningValue - totalClosingValue;
  const potentialGP = (stockSoldValue * gpPercentage / 100).toFixed(2);
  const agingGP = (agingStockValue * gpPercentage / 100).toFixed(2);
  
  // Format dates for display
  const fromDateFormatted = formatDate(fromDate);
  const toDateFormatted = formatDate(toDate);
  const reportDate = new Date().toLocaleDateString('en-US', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
  
  // Report type display name
  const reportTypeNames = {
    'detailed': 'Detailed Report',
    'summary': 'Summary Report',
    'aging': 'Aging Analysis',
    'liquidation': 'Liquidation Report'
  };
  
  // Generate report based on selected type
  let reportHTML = '';
  
  // Common header
  reportHTML += `
    <div class="report-block" id="reportContent">
      <div class="header-info">
        <h3>Stock Position Report <span class="report-type-badge">${reportTypeNames[reportType]}</span></h3>
        <div class="header-info-grid">
          <div class="header-info-item">
            <div class="header-info-label">Report Period</div>
            <div class="header-info-value">${fromDateFormatted} to ${toDateFormatted}</div>
          </div>
          <div class="header-info-item">
            <div class="header-info-label">Purchaser</div>
            <div class="header-info-value">${purchaser}</div>
          </div>
          <div class="header-info-item">
            <div class="header-info-label">Location</div>
            <div class="header-info-value">${location}</div>
          </div>
          <div class="header-info-item">
            <div class="header-info-label">Generated On</div>
            <div class="header-info-value">${reportDate}</div>
          </div>
        </div>
      </div>`;
  
  // Generate content based on report type
  switch(reportType) {
    case 'summary':
      reportHTML += generateSummaryReport(opening, closing, totalOpeningPcsQty, totalOpeningMcmQty, 
        totalOpeningPcsVal, totalOpeningMcmVal, totalClosingPcsQty, totalClosingMcmQty, 
        totalClosingPcsVal, totalClosingMcmVal, stockSoldPcs, stockSoldMcm, 
        totalStockAvailable, totalStockSold, stockLiquidationPercent, 
        agingStockQty, agingStockValue, agingDetails, avgStockTurnover, 
        stockCoverageDays, potentialGP, agingGP, fromDateFormatted, toDateFormatted);
      break;
      
    case 'aging':
      reportHTML += generateAgingReport(opening, closing, agingDetails, totalOpeningValue,
        agingStockQty, agingStockValue, agingGP, fromDateFormatted, toDateFormatted);
      break;
      
    case 'liquidation':
      reportHTML += generateLiquidationReport(opening, closing, totalOpeningPcsQty, totalOpeningMcmQty,
        totalClosingPcsQty, totalClosingMcmQty, stockSoldPcs, stockSoldMcm,
        totalStockSold, stockLiquidationPercent, stockSoldValue, potentialGP,
        fromDateFormatted, toDateFormatted);
      break;
      
    case 'detailed':
    default:
      reportHTML += generateDetailedReport(opening, closing, totalOpeningPcsQty, totalOpeningMcmQty, 
        totalOpeningPcsVal, totalOpeningMcmVal, totalClosingPcsQty, totalClosingMcmQty, 
        totalClosingPcsVal, totalClosingMcmVal, stockSoldPcs, stockSoldMcm, 
        totalStockAvailable, totalStockSold, stockLiquidationPercent, 
        agingStockQty, agingStockValue, agingDetails, avgStockTurnover, 
        stockCoverageDays, potentialGP, agingGP, fromDateFormatted, toDateFormatted);
      break;
  }
  
  // Single button for image copy
  reportHTML += `
      <div class="button-container">
        <button class="copy-btn" onclick="copyReportAsImage()">
          üìã Copy Report as Image
        </button>
      </div>
    </div>`;
  
  document.getElementById("report").innerHTML = reportHTML;
}

// Generate Summary Report
function generateSummaryReport(opening, closing, totalOpeningPcsQty, totalOpeningMcmQty, 
  totalOpeningPcsVal, totalOpeningMcmVal, totalClosingPcsQty, totalClosingMcmQty, 
  totalClosingPcsVal, totalClosingMcmVal, stockSoldPcs, stockSoldMcm, 
  totalStockAvailable, totalStockSold, stockLiquidationPercent, 
  agingStockQty, agingStockValue, agingDetails, avgStockTurnover, 
  stockCoverageDays, potentialGP, agingGP, fromDateFormatted, toDateFormatted) {
  
  const totalOpeningValue = totalOpeningPcsVal + totalOpeningMcmVal;
  const totalClosingValue = totalClosingPcsVal + totalClosingMcmVal;
  const stockSoldValue = totalOpeningValue - totalClosingValue;
  
  return `
    <h3>Executive Summary</h3>
    <table>
      <thead>
        <tr>
          <th>Key Metric</th>
          <th>Quantity</th>
          <th>Value</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>Opening Stock</strong></td>
          <td>${(totalOpeningPcsQty + totalOpeningMcmQty).toLocaleString()}</td>
          <td>${totalOpeningValue.toLocaleString()}</td>
          <td>As of ${fromDateFormatted}</td>
        </tr>
        <tr>
          <td><strong>Closing Stock</strong></td>
          <td>${(totalClosingPcsQty + totalClosingMcmQty).toLocaleString()}</td>
          <td>${totalClosingValue.toLocaleString()}</td>
          <td>As of ${toDateFormatted}</td>
        </tr>
        <tr class="highlight">
          <td><strong>Stock Liquidation</strong></td>
          <td>${totalStockSold.toLocaleString()}</td>
          <td>${stockSoldValue.toLocaleString()}</td>
          <td>${stockLiquidationPercent}% sold</td>
        </tr>
        <tr>
          <td><strong>Aging Stock (>1 year)</strong></td>
          <td>${agingStockQty.toLocaleString()}</td>
          <td>${agingStockValue.toLocaleString()}</td>
          <td>${agingDetails.length > 0 ? 'Requires attention' : 'No aging stock'}</td>
        </tr>
      </tbody>
    </table>
    
    <h3>Key Performance Indicators</h3>
    <table>
      <thead>
        <tr>
          <th>KPI</th>
          <th>Value</th>
          <th>Target</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Stock Turnover Ratio</td>
          <td>${avgStockTurnover}</td>
          <td>> 1.0</td>
          <td>${avgStockTurnover > 1 ? '‚úÖ Good' : '‚ö†Ô∏è Low'}</td>
        </tr>
        <tr>
          <td>Stock Coverage (Days)</td>
          <td>${stockCoverageDays} days</td>
          <td>30-60 days</td>
          <td>${stockCoverageDays >= 30 && stockCoverageDays <= 60 ? '‚úÖ Optimal' : '‚ö†Ô∏è Review'}</td>
        </tr>
        <tr>
          <td>Liquidation Percentage</td>
          <td>${stockLiquidationPercent}%</td>
          <td>> 50%</td>
          <td>${stockLiquidationPercent > 50 ? '‚úÖ Good' : '‚ö†Ô∏è Needs Improvement'}</td>
        </tr>
      </tbody>
    </table>`;
}

// Generate Aging Report
function generateAgingReport(opening, closing, agingDetails, totalOpeningValue,
  agingStockQty, agingStockValue, agingGP, fromDateFormatted, toDateFormatted) {
  
  return `
    <h3>Aging Stock Analysis (${fromDateFormatted} to ${toDateFormatted})</h3>
    
    <table>
      <thead>
        <tr>
          <th>Summary</th>
          <th>Quantity</th>
          <th>Value</th>
          <th>% of Total</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>Total Aging Stock (>1 year)</strong></td>
          <td>${agingStockQty.toLocaleString()}</td>
          <td>${agingStockValue.toLocaleString()}</td>
          <td>${totalOpeningValue > 0 ? ((agingStockValue / totalOpeningValue) * 100).toFixed(2) : 0}%</td>
        </tr>
        <tr>
          <td><strong>Gross Profit Impact</strong></td>
          <td colspan="2">Potential loss on aging stock</td>
          <td>${agingGP}</td>
        </tr>
      </tbody>
    </table>
    
    ${agingDetails.length > 0 ? `
    <h3>Aging Stock Details</h3>
    <table>
      <thead>
        <tr>
          <th>Year</th>
          <th>Age (Years)</th>
          <th>Quantity</th>
          <th>Value</th>
          <th>% of Total</th>
          <th>Priority</th>
        </tr>
      </thead>
      <tbody>
        ${agingDetails.map(item => `
          <tr>
            <td>${item.year}</td>
            <td>${item.age}</td>
            <td>${item.qty.toLocaleString()}</td>
            <td>${item.value.toLocaleString()}</td>
            <td>${totalOpeningValue > 0 ? ((item.value / totalOpeningValue) * 100).toFixed(2) : 0}%</td>
            <td>${item.age > 2 ? 'üî¥ High' : item.age > 1 ? 'üü° Medium' : 'üü¢ Low'}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
    
    <h3>Action Recommendations</h3>
    <table>
      <thead>
        <tr>
          <th>Age Category</th>
          <th>Action Required</th>
          <th>Timeline</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>> 2 years</td>
          <td>Immediate clearance sale, consider 40-50% discount</td>
          <td>Within 30 days</td>
        </tr>
        <tr>
          <td>1-2 years</td>
          <td>Promotional bundling, 20-30% discount</td>
          <td>Next 60 days</td>
        </tr>
      </tbody>
    </table>
    ` : '<p>No aging stock identified.</p>'}
  `;
}

// Generate Liquidation Report
function generateLiquidationReport(opening, closing, totalOpeningPcsQty, totalOpeningMcmQty,
  totalClosingPcsQty, totalClosingMcmQty, stockSoldPcs, stockSoldMcm,
  totalStockSold, stockLiquidationPercent, stockSoldValue, potentialGP,
  fromDateFormatted, toDateFormatted) {
  
  const totalOpeningQty = totalOpeningPcsQty + totalOpeningMcmQty;
  const totalClosingQty = totalClosingPcsQty + totalClosingMcmQty;
  
  return `
    <h3>Stock Liquidation Report (${fromDateFormatted} to ${toDateFormatted})</h3>
    
    <table>
      <thead>
        <tr>
          <th>Category</th>
          <th>Opening</th>
          <th>Closing</th>
          <th>Sold</th>
          <th>Liquidation %</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>PCS</strong></td>
          <td>${totalOpeningPcsQty.toLocaleString()}</td>
          <td>${totalClosingPcsQty.toLocaleString()}</td>
          <td>${stockSoldPcs.toLocaleString()}</td>
          <td>${totalOpeningPcsQty > 0 ? ((stockSoldPcs / totalOpeningPcsQty) * 100).toFixed(2) : 0}%</td>
        </tr>
        <tr>
          <td><strong>MCM</strong></td>
          <td>${totalOpeningMcmQty.toLocaleString()}</td>
          <td>${totalClosingMcmQty.toLocaleString()}</td>
          <td>${stockSoldMcm.toLocaleString()}</td>
          <td>${totalOpeningMcmQty > 0 ? ((stockSoldMcm / totalOpeningMcmQty) * 100).toFixed(2) : 0}%</td>
        </tr>
        <tr class="highlight">
          <td><strong>Total</strong></td>
          <td>${totalOpeningQty.toLocaleString()}</td>
          <td>${totalClosingQty.toLocaleString()}</td>
          <td>${totalStockSold.toLocaleString()}</td>
          <td>${stockLiquidationPercent}%</td>
        </tr>
      </tbody>
    </table>
    
    <h3>Performance Analysis</h3>
    <table>
      <thead>
        <tr>
          <th>Performance Indicator</th>
          <th>Value</th>
          <th>Rating</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Overall Liquidation Rate</td>
          <td>${stockLiquidationPercent}%</td>
          <td>${stockLiquidationPercent > 60 ? 'Excellent' : stockLiquidationPercent > 40 ? 'Good' : 'Poor'}</td>
        </tr>
        <tr>
          <td>Total Value Liquidated</td>
          <td>${stockSoldValue.toLocaleString()}</td>
          <td>${stockSoldValue > 10000 ? 'High' : stockSoldValue > 5000 ? 'Moderate' : 'Low'}</td>
        </tr>
        <tr>
          <td>Gross Profit Realized</td>
          <td>${potentialGP}</td>
          <td>${parseFloat(potentialGP) > 2000 ? 'Excellent' : parseFloat(potentialGP) > 1000 ? 'Good' : 'Low'}</td>
        </tr>
        <tr>
          <td>Efficiency Score</td>
          <td>${calculateEfficiencyScore(stockLiquidationPercent, parseFloat(potentialGP))}</td>
          <td>${calculateEfficiencyScore(stockLiquidationPercent, parseFloat(potentialGP)) > 80 ? 'High' : 
                calculateEfficiencyScore(stockLiquidationPercent, parseFloat(potentialGP)) > 60 ? 'Medium' : 'Low'}</td>
        </tr>
      </tbody>
    </table>
  `;
}

// Generate Detailed Report
function generateDetailedReport(opening, closing, totalOpeningPcsQty, totalOpeningMcmQty, 
  totalOpeningPcsVal, totalOpeningMcmVal, totalClosingPcsQty, totalClosingMcmQty, 
  totalClosingPcsVal, totalClosingMcmVal, stockSoldPcs, stockSoldMcm, 
  totalStockAvailable, totalStockSold, stockLiquidationPercent, 
  agingStockQty, agingStockValue, agingDetails, avgStockTurnover, 
  stockCoverageDays, potentialGP, agingGP, fromDateFormatted, toDateFormatted) {
  
  const totalOpeningValue = totalOpeningPcsVal + totalOpeningMcmVal;
  const totalClosingValue = totalClosingPcsVal + totalClosingMcmVal;
  const stockSoldValue = totalOpeningValue - totalClosingValue;
  
  return `
    <h3>Executive Summary</h3>
    <table>
      <thead>
        <tr>
          <th>Key Metric</th>
          <th>Quantity</th>
          <th>Value</th>
          <th>Analysis</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>Opening Stock</strong></td>
          <td>${(totalOpeningPcsQty + totalOpeningMcmQty).toLocaleString()}</td>
          <td>${totalOpeningValue.toLocaleString()}</td>
          <td>As of ${fromDateFormatted}</td>
        </tr>
        <tr>
          <td><strong>Closing Stock</strong></td>
          <td>${(totalClosingPcsQty + totalClosingMcmQty).toLocaleString()}</td>
          <td>${totalClosingValue.toLocaleString()}</td>
          <td>As of ${toDateFormatted}</td>
        </tr>
        <tr class="highlight">
          <td><strong>Stock Liquidation</strong></td>
          <td>${totalStockSold.toLocaleString()}</td>
          <td>${stockSoldValue.toLocaleString()}</td>
          <td>${stockLiquidationPercent}% of available stock</td>
        </tr>
        <tr>
          <td><strong>Aging Stock (>1 year)</strong></td>
          <td>${agingStockQty.toLocaleString()}</td>
          <td>${agingStockValue.toLocaleString()}</td>
          <td>${agingDetails.length} year${agingDetails.length !== 1 ? 's' : ''} aged</td>
        </tr>
      </tbody>
    </table>
    
    <h3>Performance Indicators</h3>
    <table>
      <thead>
        <tr>
          <th>KPI</th>
          <th>Value</th>
          <th>Target</th>
          <th>Status</th>
          <th>Recommendation</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Stock Turnover Ratio</td>
          <td>${avgStockTurnover}</td>
          <td>> 1.0</td>
          <td>${avgStockTurnover > 1 ? '‚úÖ Good' : '‚ö†Ô∏è Low'}</td>
          <td>${avgStockTurnover > 1 ? 'Maintain current level' : 'Increase sales velocity'}</td>
        </tr>
        <tr>
          <td>Stock Coverage (Days)</td>
          <td>${stockCoverageDays} days</td>
          <td>30-60 days</td>
          <td>${stockCoverageDays >= 30 && stockCoverageDays <= 60 ? '‚úÖ Optimal' : '‚ö†Ô∏è Review'}</td>
          <td>${stockCoverageDays > 60 ? 'Reduce inventory levels' : stockCoverageDays < 30 ? 'Increase safety stock' : 'Optimal level'}</td>
        </tr>
        <tr>
          <td>Liquidation Percentage</td>
          <td>${stockLiquidationPercent}%</td>
          <td>> 50%</td>
          <td>${stockLiquidationPercent > 50 ? '‚úÖ Good' : '‚ö†Ô∏è Needs Improvement'}</td>
          <td>${stockLiquidationPercent > 50 ? 'Good movement' : 'Focus on promotions'}</td>
        </tr>
        <tr>
          <td>Gross Profit Potential</td>
          <td>${potentialGP}</td>
          <td>-</td>
          <td>‚úÖ Realized</td>
          <td>Based on 20% margin</td>
        </tr>
        <tr>
          <td>Aging Stock Impact</td>
          <td>${agingGP}</td>
          <td>Minimize</td>
          <td>‚ö†Ô∏è Opportunity Loss</td>
          <td>Consider clearance sale</td>
        </tr>
      </tbody>
    </table>
    
    ${agingDetails.length > 0 ? `
    <h3>Aging Analysis Details</h3>
    <table>
      <thead>
        <tr>
          <th>Year</th>
          <th>Age (Years)</th>
          <th>Quantity</th>
          <th>Value</th>
          <th>% of Total</th>
          <th>Action Required</th>
        </tr>
      </thead>
      <tbody>
        ${agingDetails.map(item => `
          <tr>
            <td>${item.year}</td>
            <td>${item.age}</td>
            <td>${item.qty.toLocaleString()}</td>
            <td>${item.value.toLocaleString()}</td>
            <td>${totalOpeningValue > 0 ? ((item.value / totalOpeningValue) * 100).toFixed(2) : 0}%</td>
            <td>${item.age > 2 ? 'Urgent: Clearance needed' : 'Monitor closely'}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
    ` : ''}
    
    <h3>Year-wise Stock Position</h3>
    <table>
      <thead>
        <tr>
          <th>Year</th>
          <th colspan="2">Opening Stock</th>
          <th colspan="2">Closing Stock</th>
          <th colspan="2">Movement</th>
        </tr>
        <tr>
          <th></th>
          <th>Qty</th><th>Value</th>
          <th>Qty</th><th>Value</th>
          <th>Qty</th><th>Value</th>
        </tr>
      </thead>
      <tbody>
        ${years.map(year => {
          const opQty = (opening[year]?.pcsQty || 0) + (opening[year]?.mcmQty || 0);
          const opVal = (opening[year]?.pcsVal || 0) + (opening[year]?.mcmVal || 0);
          const clQty = (closing[year]?.pcsQty || 0) + (closing[year]?.mcmQty || 0);
          const clVal = (closing[year]?.pcsVal || 0) + (closing[year]?.mcmVal || 0);
          const mvQty = opQty - clQty;
          const mvVal = opVal - clVal;
          
          return `
            <tr>
              <td>${year}</td>
              <td>${opQty.toLocaleString()}</td>
              <td>${opVal.toLocaleString()}</td>
              <td>${clQty.toLocaleString()}</td>
              <td>${clVal.toLocaleString()}</td>
              <td>${mvQty.toLocaleString()}</td>
              <td>${mvVal.toLocaleString()}</td>
            </tr>
          `;
        }).join('')}
      </tbody>
    </table>
  `;
}

function calculateEfficiencyScore(liquidationPercent, grossProfit) {
  let score = 0;
  score += Math.min(60, liquidationPercent * 0.6);
  score += Math.min(40, grossProfit / 100);
  return Math.min(100, Math.round(score));
}

function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  });
}

// Simple image copy function that WORKS
async function copyReportAsImage() {
  const reportContent = document.getElementById('reportContent');
  if (!reportContent) {
    alert('Please generate a report first!');
    return;
  }
  
  try {
    // Save button state
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '‚è≥ Generating...';
    button.disabled = true;
    
    // Check if html2canvas is available
    if (typeof html2canvas === 'undefined') {
      // Load html2canvas
      await new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = 'https://html2canvas.hertzen.com/dist/html2canvas.min.js';
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }
    
    // Create a copy of the report without the copy button
    const tempDiv = document.createElement('div');
    tempDiv.style.cssText = `
      position: fixed;
      left: -9999px;
      top: -9999px;
      width: 800px;
      background: white;
      padding: 20px;
      font-family: Arial, sans-serif;
    `;
    
    // Clone the report content
    const clonedContent = reportContent.cloneNode(true);
    
    // Remove the copy button from cloned content
    const copyButton = clonedContent.querySelector('.button-container');
    if (copyButton) {
      copyButton.remove();
    }
    
    tempDiv.appendChild(clonedContent);
    document.body.appendChild(tempDiv);
    
    // Generate the canvas
    const canvas = await html2canvas(tempDiv, {
      scale: 2,
      backgroundColor: '#ffffff',
      useCORS: true,
      logging: false
    });
    
    // Remove temp div
    document.body.removeChild(tempDiv);
    
    // Convert canvas to blob
    canvas.toBlob(async (blob) => {
      try {
        // Try to copy to clipboard
        await navigator.clipboard.write([
          new ClipboardItem({
            'image/png': blob
          })
        ]);
        
        button.innerHTML = '‚úÖ Copied!';
        setTimeout(() => {
          button.innerHTML = originalText;
          button.disabled = false;
        }, 2000);
        
        alert('‚úÖ Report image copied to clipboard! You can now paste it anywhere.');
        
      } catch (clipboardError) {
        console.error('Clipboard API failed:', clipboardError);
        
        // Fallback: Download the image
        const link = document.createElement('a');
        link.download = 'stock-report.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
        
        button.innerHTML = 'üíæ Downloaded';
        setTimeout(() => {
          button.innerHTML = originalText;
          button.disabled = false;
        }, 2000);
        
        alert('‚ö†Ô∏è Could not copy to clipboard directly. Image has been downloaded instead. You can open it and copy manually.');
      }
    });
    
  } catch (error) {
    console.error('Error:', error);
    
    // Restore button
    if (event && event.target) {
      event.target.innerHTML = 'üìã Copy Report as Image';
      event.target.disabled = false;
    }
    
    alert('Error generating image. Please make sure you have internet connection and try again.');
  }
}

function readTable(id){
  const data={}
  const rows = document.querySelectorAll(`#${id} tbody tr`);
  rows.forEach((r,i)=>{
    const inputs = r.querySelectorAll("input");
    data[years[i]] = {
      pcsQty:+inputs[0].value, pcsVal:+inputs[1].value,
      mcmQty:+inputs[2].value, mcmVal:+inputs[3].value
    };
  });
  return data;
}

function total(obj,...keys){
  return years.reduce((s,y)=> s + keys.reduce((a,k)=>a+(obj[y][k]||0),0), 0);
}
</script>

</body>
</html>